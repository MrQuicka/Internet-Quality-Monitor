<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Internet Quality Monitor</title>

  <!-- Chart.js (oficiální CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f1115;
      --panel: #181b22;
      --text: #e6e8ee;
      --muted: #9aa0aa;
      --accent: #6aa6ff;
      --ok: #36c275;
      --warn: #f0b429;
      --bad: #f66e6e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
    }

    header {
      padding: 16px 20px;
      background: #151922;
      border-bottom: 1px solid #222837;
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 56px; /* pro jistotu proti flex shrink bugům */
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      letter-spacing: .2px;
    }

    main {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid #22283a;
      border-radius: 14px;
      padding: 16px;
      min-width: 0;   /* důležité uvnitř grid/flex kontejnerů */
    }

    .row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .stat {
      background: #121620;
      border: 1px solid #22283a;
      border-radius: 12px;
      padding: 12px;
      min-height: 84px;
    }

    .stat .label {
      font-size: 12px;
      color: var(--muted);
    }

    .stat .value {
      margin-top: 6px;
      font-size: 22px;
      font-weight: 700;
    }

    .value.ok { color: var(--ok); }
    .value.warn { color: var(--warn); }
    .value.bad { color: var(--bad); }

    .chart-card h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 600;
    }

    /* === Klíčové fixy proti nekonečnému roztahování === */
    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;   /* pevná výška */
      min-height: 0;   /* důležité ve flex/grid kontextu */
    }

    canvas {
      display: block;
      /* žádné height: 100% ani 100vh na canvasu */
      max-width: 100%;
    }

    footer {
      padding: 16px 20px 28px;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 980px) {
      .row { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Internet Quality Monitor</h1>
  </header>

  <main>
    <section class="row">
      <div class="stat">
        <div class="label">Ping</div>
        <div id="pingValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Jitter</div>
        <div id="jitterValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Download</div>
        <div id="downValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Upload</div>
        <div id="upValue" class="value">–</div>
      </div>
    </section>

    <section class="card chart-card">
      <h2>Vývoj pingu (ms)</h2>
      <div class="chart-container">
        <canvas id="latencyChart"></canvas>
      </div>
    </section>
  </main>

  <footer>
    Aktualizuje se každých 10&nbsp;s. Graf zobrazuje omezené množství bodů kvůli výkonu.
  </footer>

  <script>
    // ================== Konfigurace frontendu ==================
    const API_BASES = [
      '/api',              // primárně
      ''                   // fallback (pokud backend servíruje rootové cesty)
    ];
    const HISTORY_PATHS = ['/history', '/api/history', '/data', '/history.json'];
    const LATEST_PATHS  = ['/latest', '/api/latest', '/data/latest'];

    const REFRESH_MS = 10_000;
    const MAX_POINTS = 720;        // limit bodů v grafu (cca 2 hodiny po 10s)
    const DECIMALS   = 1;

    // ================== Pomocné funkce ==================
    const $ = (sel) => document.querySelector(sel);
    const pingEl   = $('#pingValue');
    const jitterEl = $('#jitterValue');
    const downEl   = $('#downValue');
    const upEl     = $('#upValue');

    function fmt(v, unit = '') {
      if (v === null || v === undefined || Number.isNaN(v)) return '–';
      return `${Number(v).toFixed(DECIMALS)}${unit}`;
    }

    function classify(value, warn, bad) {
      if (value === null || value === undefined || Number.isNaN(value)) return '';
      if (value >= bad) return 'bad';
      if (value >= warn) return 'warn';
      return 'ok';
    }

    async function tryFetch(paths) {
      for (const base of API_BASES) {
        for (const p of paths) {
          const url = base.endsWith('/') || p.startsWith('/') ? `${base}${p}` : `${base}/${p}`;
          try {
            const r = await fetch(url, { cache: 'no-store' });
            if (r.ok) {
              return await r.json();
            }
          } catch (_) { /* zkus další variantu */ }
        }
      }
      throw new Error('Nepodařilo se načíst data z žádné známé cesty.');
    }

    // ================== Chart.js – inicializace (s fixy) ==================
    const ctx = document.getElementById('latencyChart').getContext('2d');

    const chartData = {
      labels: [],
      datasets: [{
        label: 'Ping (ms)',
        data: [],
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    };

    const latencyChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,  // KLÍČOVÉ proti resize smyčkám
        animation: false,            // šetří CPU
        parsing: false,
        normalized: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: (item) => ` ${Number(item.parsed.y).toFixed(DECIMALS)} ms`
            }
          }
        },
        scales: {
          x: {
            ticks: { maxRotation: 0, autoSkip: true },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,.06)' },
            ticks: {
              callback: (v) => `${v} ms`
            }
          }
        }
      }
    });

    function pushPoint(tsLabel, valueMs) {
      chartData.labels.push(tsLabel);
      chartData.datasets[0].data.push(valueMs);

      if (chartData.labels.length > MAX_POINTS) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
      }
      latencyChart.update('none'); // bez animací
    }

    function setStats({ ping_ms, jitter_ms, download_mbps, upload_mbps }) {
      const ping   = Number(ping_ms);
      const jitter = Number(jitter_ms);
      const down   = Number(download_mbps);
      const up     = Number(upload_mbps);

      pingEl.textContent   = fmt(ping, ' ms');
      jitterEl.textContent = fmt(jitter, ' ms');
      downEl.textContent   = fmt(down, ' Mb/s');
      upEl.textContent     = fmt(up, ' Mb/s');

      // barevná klasifikace (volitelné – uprav prahy dle potřeby)
      pingEl.className   = `value ${classify(ping, 40, 80)}`;
      jitterEl.className = `value ${classify(jitter, 20, 40)}`;
      downEl.className   = `value ${classify(100 - down, 60, 80)}`; // tady jen vizuální hrátka
      upEl.className     = `value ${classify(50 - up, 20, 35)}`;
    }

    // ================== Načtení historie a posledních dat ==================
    async function loadHistory() {
      try {
        const data = await tryFetch(HISTORY_PATHS);
        // očekávaný formát: pole { ts | timestamp | time, ping_ms }
        for (const row of data) {
          const ts = row.ts || row.timestamp || row.time || '';
          const label = typeof ts === 'string' ? ts : new Date(ts * 1000).toLocaleTimeString();
          const val = Number(row.ping_ms ?? row.ping ?? row.latency_ms ?? row.latency);
          if (!Number.isNaN(val)) pushPoint(label, val);
        }
      } catch (e) {
        console.warn('Historii se nepodařilo načíst:', e.message);
      }
    }

    async function fetchLatest() {
      try {
        const rec = await tryFetch(LATEST_PATHS);
        // očekávaný formát: { ts, ping_ms, jitter_ms, download_mbps, upload_mbps }
        const ts = rec.ts || rec.timestamp || rec.time || '';
        const label = typeof ts === 'string' ? ts : new Date(ts * 1000).toLocaleTimeString();
        const ping = Number(rec.ping_ms ?? rec.ping ?? rec.latency_ms ?? rec.latency);

        if (!Number.isNaN(ping)) pushPoint(label, ping);
        setStats({
          ping_ms: ping,
          jitter_ms: rec.jitter_ms ?? rec.jitter,
          download_mbps: rec.download_mbps ?? rec.download,
          upload_mbps: rec.upload_mbps ?? rec.upload
        });
      } catch (e) {
        console.error('Načtení posledního záznamu selhalo:', e);
      }
    }

    // ================== Polling (jen jeden interval) ==================
    let pollTimer = null;

    function startPolling() {
      if (pollTimer) return;
      fetchLatest();
      pollTimer = setInterval(fetchLatest, REFRESH_MS);
    }

    function stopPolling() {
      if (!pollTimer) return;
      clearInterval(pollTimer);
      pollTimer = null;
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopPolling(); else startPolling();
    });

    // Start
    (async function init() {
      await loadHistory();
      startPolling();
    })();
  </script>
</body>
</html>
