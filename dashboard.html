<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Internet Quality Monitor</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f1115;
      --panel: #181b22;
      --text: #e6e8ee;
      --muted: #9aa0aa;
      --accent: #6aa6ff;
      --ok: #36c275;
      --warn: #f0b429;
      --bad: #f66e6e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
    }
    header {
      padding: 16px 20px;
      background: #151922;
      border-bottom: 1px solid #222837;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-height: 56px;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: .2px; }

    .actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      background: var(--accent);
      border: 0; color: #0b1220; font-weight: 700;
      padding: 10px 14px; border-radius: 10px; cursor: pointer;
    }
    .btn[disabled] { opacity: .6; cursor: default; }
    .hint { color: var(--muted); font-size: 12px; }

    main {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .card {
      background: var(--panel);
      border: 1px solid #22283a;
      border-radius: 14px;
      padding: 16px;
      min-width: 0;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .stat {
      background: #121620;
      border: 1px solid #22283a;
      border-radius: 12px;
      padding: 12px;
      min-height: 84px;
    }
    .stat .label { font-size: 12px; color: var(--muted); }
    .stat .value { margin-top: 6px; font-size: 22px; font-weight: 700; }
    .value.ok { color: var(--ok); }
    .value.warn { color: var(--warn); }
    .value.bad { color: var(--bad); }

    .chart-card h2 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; }

    /* Fix proti resize-smyčkám */
    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;     /* pevná výška */
      min-height: 0;
    }
    canvas { display: block; max-width: 100%; }

    footer { padding: 16px 20px 28px; color: var(--muted); font-size: 12px; }

    @media (max-width: 980px) { .row { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Internet Quality Monitor</h1>
    <div class="actions">
      <button id="runBtn" class="btn">Spustit test</button>
      <span id="runHint" class="hint"></span>
    </div>
  </header>

  <main>
    <section class="row">
      <div class="stat">
        <div class="label">Ping</div>
        <div id="pingValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Jitter</div>
        <div id="jitterValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Download</div>
        <div id="downValue" class="value">–</div>
      </div>
      <div class="stat">
        <div class="label">Upload</div>
        <div id="upValue" class="value">–</div>
      </div>
    </section>

    <section class="card chart-card">
      <h2>Vývoj pingu (ms)</h2>
      <div class="chart-container">
        <canvas id="latencyChart"></canvas>
      </div>
    </section>
  </main>

  <footer>
    Aktualizace každých 10&nbsp;s • Tlačítkem lze spustit test kdykoliv ručně.
  </footer>

  <script>
    // ===== Konfigurace frontendu (pevné API cesty) =====
    const API = {
      HISTORY: '/api/history',
      LATEST:  '/api/latest',
      RUN:     '/api/run'
    };

    const REFRESH_MS = 10_000;
    const MAX_POINTS = 720;
    const DECIMALS   = 1;

    // ===== Pomocné =====
    const $ = (sel) => document.querySelector(sel);
    const pingEl   = $('#pingValue');
    const jitterEl = $('#jitterValue');
    const downEl   = $('#downValue');
    const upEl     = $('#upValue');
    const runBtn   = $('#runBtn');
    const runHint  = $('#runHint');

    function fmt(v, unit='') {
      if (v === null || v === undefined || Number.isNaN(v)) return '–';
      return `${Number(v).toFixed(DECIMALS)}${unit}`;
    }
    function classify(value, warn, bad) {
      if (value === null || value === undefined || Number.isNaN(value)) return '';
      if (value >= bad) return 'bad';
      if (value >= warn) return 'warn';
      return 'ok';
    }

    // ===== Chart.js =====
    const ctx = document.getElementById('latencyChart').getContext('2d');
    const chartData = {
      labels: [],
      datasets: [{
        label: 'Ping (ms)',
        data: [],
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    };
    const latencyChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        parsing: false,
        normalized: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0 }, grid: { display: false } },
          y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.06)' }, ticks: { callback: v => `${v} ms` } }
        }
      }
    });
    function pushPoint(label, val) {
      chartData.labels.push(label);
      chartData.datasets[0].data.push(val);
      if (chartData.labels.length > MAX_POINTS) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
      }
      latencyChart.update('none');
    }
    function setStats({ ping_ms, jitter_ms, download_mbps, upload_mbps }) {
      const ping   = Number(ping_ms);
      const jitter = Number(jitter_ms);
      const down   = Number(download_mbps);
      const up     = Number(upload_mbps);
      pingEl.textContent   = fmt(ping, ' ms');
      jitterEl.textContent = fmt(jitter, ' ms');
      downEl.textContent   = fmt(down, ' Mb/s');
      upEl.textContent     = fmt(up, ' Mb/s');
      pingEl.className   = `value ${classify(ping, 40, 80)}`;
      jitterEl.className = `value ${classify(jitter, 20, 40)}`;
      downEl.className   = `value`;
      upEl.className     = `value`;
    }

    // ===== Načítání dat =====
    async function loadHistory() {
      try {
        const r = await fetch(API.HISTORY, { cache: 'no-store' });
        if (!r.ok) throw new Error(`${r.status}`);
        const data = await r.json(); // oček.: [{ts, ping_ms, ...}, ...]
        for (const row of data) {
          const ts = row.ts || row.timestamp || row.time || '';
          const label = typeof ts === 'string' ? ts : new Date(ts * 1000).toLocaleTimeString();
          const val = Number(row.ping_ms ?? row.ping ?? row.latency_ms ?? row.latency);
          if (!Number.isNaN(val)) pushPoint(label, val);
        }
      } catch (e) {
        console.warn('Historie není dostupná (zatím):', e.message);
      }
    }
    async function fetchLatest() {
      try {
        const r = await fetch(API.LATEST, { cache: 'no-store' });
        if (!r.ok) throw new Error(`${r.status}`);
        const rec = await r.json();  // oček.: {ts, ping_ms, jitter_ms, download_mbps, upload_mbps}
        const ts = rec.ts || rec.timestamp || rec.time || '';
        const label = typeof ts === 'string' ? ts : new Date(ts * 1000).toLocaleTimeString();
        const ping = Number(rec.ping_ms ?? rec.ping ?? rec.latency_ms ?? rec.latency);
        if (!Number.isNaN(ping)) pushPoint(label, ping);
        setStats(rec);
      } catch (e) {
        // ticho – jen to ještě neexistuje
      }
    }

    // ===== Ruční test =====
    async function runManualTest() {
      runBtn.disabled = true;
      runHint.textContent = 'Probíhá test...';
      try {
        const r = await fetch(API.RUN, { method: 'POST' });
        if (!r.ok) throw new Error(`${r.status}`);
        const rec = await r.json();
        const ts = rec.ts || rec.timestamp || rec.time || '';
        const label = typeof ts === 'string' ? ts : new Date(ts * 1000).toLocaleTimeString();
        const ping = Number(rec.ping_ms ?? rec.ping ?? rec.latency_ms ?? rec.latency);
        if (!Number.isNaN(ping)) pushPoint(label, ping);
        setStats(rec);
        runHint.textContent = 'Hotovo ✔';
      } catch (e) {
        console.error('Ruční test selhal:', e);
        runHint.textContent = 'Chyba testu';
      } finally {
        setTimeout(() => { runHint.textContent = ''; runBtn.disabled = false; }, 1500);
      }
    }
    runBtn.addEventListener('click', runManualTest);

    // ===== Polling (jeden interval, pauza při skryté kartě) =====
    let pollTimer = null;
    function startPolling() { if (!pollTimer) { fetchLatest(); pollTimer = setInterval(fetchLatest, REFRESH_MS); } }
    function stopPolling()  { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }
    document.addEventListener('visibilitychange', () => document.hidden ? stopPolling() : startPolling());

    // Start
    (async function init() {
      await loadHistory();
      startPolling();
    })();
  </script>
</body>
</html>
